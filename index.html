<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script type="module">
    // ‚úÖ Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, updateDoc, writeBatch, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByEiQP04T_RxQ88CMZRWxUMI_r9ra5ub4",
      authDomain: "purdto-platform.firebaseapp.com",
      projectId: "purdto-platform",
      messagingSenderId: "670687363597",
      appId: "1:670687363597:web:dd96a5936c87ad27dd0b44"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const restaurantId = "vyse";
    const seatMap = document.getElementById("seatMap");
    const total = document.getElementById("total");
    const pricePerSeat = 50;
    const selected = new Set();
    const seatElements = {};

    const allSeats = [
      "A1", "A2", "A3", "A4", "A5",
      "B1", "B2", "B3", "B4", "B5",
      "C1", "C2", "C3", "C4", "C5",
      "D1", "D2", "D3", "D4", "D5",
      "E1", "E2", "E3", "E4", "E5",
      "F1", "F2", "F3", "F4", "F5"
    ];

    // üîÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
    allSeats.forEach(id => {
      const seat = document.createElement("div");
      seat.className = "seat";
      seat.textContent = id;
      seat.dataset.id = id;
      seatMap.appendChild(seat);
      seatElements[id] = seat;
    });

    // üëÄ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Firestore ‡πÅ‡∏ö‡∏ö real-time
    const tablesRef = collection(db, "restaurants", restaurantId, "tables");
    onSnapshot(tablesRef, snapshot => {
      snapshot.docChanges().forEach(change => {
        const id = change.doc.id;
        const data = change.doc.data();
        const seat = seatElements[id];
        if (!seat) return;

        seat.className = "seat";
        if (data.status === "reserved") {
          seat.classList.add("reserved");
          seat.onclick = null;
        } else if (data.status === "blocked") {
          seat.classList.add("reserved");
          seat.textContent = "‚ùå";
          seat.onclick = null;
        } else {
          seat.onclick = () => {
            seat.classList.toggle("selected");
            if (selected.has(id)) {
              selected.delete(id);
            } else {
              selected.add(id);
            }
            total.textContent = selected.size * pricePerSeat;
          };
        }
      });
    });

    window.reserveSeats = async (userId) => {
      if (selected.size === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô");
        return;  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
      }

      const now = new Date();
      const batch = writeBatch(db);  // ‡∏™‡∏£‡πâ‡∏≤‡∏á batch ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏≤‡∏¢‡πÜ ‡πÇ‡∏ï‡πä‡∏∞
      let reservedSeats = 0;  // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏ô Firestore
      for (const id of selected) {
        const ref = doc(db, "restaurants", restaurantId, "tables", id);
        batch.update(ref, {
          status: "reserved",  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡πá‡∏ô "reserved"
          reservedBy: userId,  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å userId ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á
          timestamp: now       // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
        });
        reservedSeats++;  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á
      }

      try {
        // ‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        await batch.commit();
        console.log(`${reservedSeats} seats reserved successfully!`);

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        total.textContent = reservedSeats * pricePerSeat;
      } catch (error) {
        console.error("Error committing batch:", error);  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á");
      }
    };

    // ‚úÖ LIFF init
    window.onload = function () {
      liff.init({ liffId: "2007619597-pL1yYoj3" }) // ‡πÉ‡∏™‡πà LIFF ID ‡∏à‡∏£‡∏¥‡∏á
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            liff.getProfile().then(profile => {
              window.userId = profile.userId;
              window.displayName = profile.displayName;
            });
          }
        })
        .catch(err => {
          console.error("LIFF Initialization failed", err);
        });
    };

    function bookSeats() {
      if (selected.size === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }

      window.reserveSeats(window.userId)
        .then(() => {
          console.log("Booking successful!");  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ reserveSeats() ‡πÅ‡∏•‡πâ‡∏ß
          const flexMessage = {
            type: "flex",
            altText: "üìå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞",
            contents: {
              type: "bubble",
              header: {
                type: "box",
                layout: "vertical",
                contents: [{
                  type: "text",
                  text: "üìå ‡∏£‡πâ‡∏≤‡∏ô Vyse",
                  weight: "bold",
                  size: "lg",
                  color: "#f59e0b"
                }]
              },
              body: {
                type: "box",
                layout: "vertical",
                spacing: "sm",
                contents: [
                  {
                    type: "text",
                    text: `‡∏Ñ‡∏∏‡∏ì ${window.displayName} ‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞`,
                    weight: "bold",
                    size: "md"
                  },
                  {
                    type: "text",
                    text: `‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á: ${Array.from(selected).join(", ")}`,  // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    size: "sm",
                    wrap: true
                  },
                  {
                    type: "text",
                    text: `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${selected.size * pricePerSeat} ‡∏ö‡∏≤‡∏ó`,  // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
                    size: "sm",
                    weight: "bold",
                    color: "#10b981"
                  }
                ]
              }
            }
          };

          // ‡∏™‡πà‡∏á Flex Message ‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
          liff.sendMessages([flexMessage]);
        })
        .then(() => {
          alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          liff.closeWindow();  // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF
        })
        .catch(err => {
          console.error("Send message error:", err);
          alert("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        });
    }
  </script>

  <style>
    /* Your CSS styles go here */
    .restaurant-name {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0 12px;
      color: #facc15;
      text-shadow: 0 2px 10px rgba(0,0,0,0.6);
    }
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(to bottom, #2d004b, #0e0e0e);
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .container { max-width: 400px; width: 100%; padding: 20px; box-sizing: border-box; }
    .stage { background: #b91c1c; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 16px; }
    .seat-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
    .seat { background: #444; padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; }
    .seat.selected { background: #facc15; color: black; }
    .seat.reserved { background: #9ca3af; cursor: not-allowed; }
    .legend { display: flex; justify-content: space-around; font-size: 14px; margin-bottom: 10px; }
    .legend div { display: flex; align-items: center; gap: 6px; }
    .dot { width: 12px; height: 12px; border-radius: 3px; }
    .dot.available { background: #444; }
    .dot.selected { background: #facc15; }
    .dot.reserved { background: #9ca3af; }
    .summary { text-align: center; margin-bottom: 10px; }
    button { width: 100%; padding: 12px; background: #f59e0b; border: none; border-radius: 8px; font-size: 16px; color: black; cursor: pointer; }
  </style>
</head>
<body>
  <h1 class="restaurant-name">Vyse</h1>
  <div class="container">
    <div style="display: flex; justify-content: flex-start;">
      <button onclick="location.href='All in.html'" style="background: #fff; color: #000; font-size: 14px; padding: 6px 12px; border: none; border-radius: 6px; width: auto; min-width: 80px; cursor: pointer;">
        All In
      </button>
    </div>
  </div>

  <div class="container">
    <div class="stage">‡πÄ‡∏ß‡∏ó‡∏µ</div>
    <div class="seat-map" id="seatMap"></div>
    <div class="legend">
      <div><div class="dot available"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
      <div><div class="dot reserved"></div> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
      <div><div class="dot selected"></div> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
    <div class="summary">‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó</div>
    <button onclick="bookSeats()">‡∏à‡∏≠‡∏á‡πÄ‡∏•‡∏¢</button>
  </div>
</body>
</html>
